name: Build Binary with Nuitka and Upload Artifact
on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-windows:
    name: Build Windows binary and upload (Nuitka-Action)
    runs-on: windows-latest
    steps:
      - name: Download source tarball
        shell: pwsh
        run: |
          Invoke-WebRequest `
            -Uri "https://github.com/yt-dlp/yt-dlp-nightly-builds/releases/latest/download/yt-dlp.tar.gz" `
            -OutFile yt-dlp.tar.gz
          mkdir src
          tar -xzf yt-dlp.tar.gz -C src

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install build tooling and install local patched package
        shell: pwsh
        run: |
          python -m pip install --upgrade pip setuptools wheel hatchling
          python -m pip install --upgrade nuitka

      - name: Patch _video.py
        shell: bash
        run: |
          sed -i "/if[[:space:]]\+fmt_stream\.get('targetDurationSec'):/,/^[[:space:]]*continue/s/^[[:space:]]*/&#/" src/yt-dlp/yt_dlp/extractor/youtube/_video.py
          # Reinstall local package to ensure patched files are used by the build
          python -m pip install --upgrade --force-reinstall ./src/yt-dlp[default]
          
      - name: Build with Nuitka Action
        uses: Nuitka/Nuitka-Action@main
        with:
          mode: 'standalone'
          # Use module mode so Nuitka runs the package as a module (-m)
          python-flag: '-m'
          # Give the package/module name, not the __main__.py path
          script-name: 'yt_dlp'
          output-dir: 'dist'
          output-file: 'yt-dlp-nuitka.exe'
          include-package: 'yt_dlp'
          # If you need package data files included, list the package(s) explicitly
          include-package-data: 'yt_dlp'
          disable-console: 'false'

      - name: Locate and copy Nuitka output to release_artifacts
        shell: pwsh
        run: |
          if (Test-Path release_artifacts) { Remove-Item -Recurse -Force release_artifacts }
          New-Item -ItemType Directory -Path release_artifacts | Out-Null

          # Nuitka Action writes to output-dir; search for the exe
          $exe = Get-ChildItem -Path dist -Recurse -Filter "yt-dlp-nuitka.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $exe) {
            # Fallback: find any yt-dlp exe produced
            $exe = Get-ChildItem -Path . -Recurse -Filter "yt-dlp*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          }
          if (-not $exe) {
            Write-Host "Expected Nuitka binary not found; listing dist/ for debugging"
            if (Test-Path dist) { Get-ChildItem dist -Recurse | Write-Host }
            Get-ChildItem -Recurse | Where-Object { $_.Extension -eq '.exe' } | Select-Object -First 20 | Write-Host
            exit 1
          }
          Copy-Item $exe.FullName release_artifacts\yt-dlp-nuitka.exe -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-binary-windows
          path: release_artifacts/*
          retention-days: 14
